# SecOps Dashboards as Code

This repository provides a framework for managing SecOps Native Dashboards as Code. 
It enables a robust GitOps workflow with version control, automated validation, and a CI/CD pipeline that provides direct feedback on pull requests before deploying changes.

![GitHub CICD Pipeline](./images/diagram.png)

"Icon made by Freepik from www.flaticon.com"
---
## ğŸš€ Features

This framework is built around a two-stage deployment process managed by a CI/CD pipeline:

*   **Plan (`plan`):**
    1.  **Validation:** Parses the dashboard JSON files in the `dashboards/` directory.
    2.  **Comparison:** Compares the local dashboard configurations against the dashboards in the remote environment.
    3.  **Execution Plan:** Generates a plan detailing which dashboards will be `created`, `updated`, or `deleted`.
    4.  **PR Commenting:** Posts a detailed comment on the pull request with the outcome of the plan, using status emojis (âœ…, âŒ, â³) for a clear and immediate feedback loop.

*   **Apply (`apply`):**
    *   After a pull request is merged, this command applies the changes outlined in the plan, creating, updating, or deleting dashboards in the remote environment.

*   **Download (`download`):**
    *   A utility to fetch existing dashboards from the remote environment and save them as JSON files in the `dashboards/` directory. This is useful for initially populating the repository or syncing with manually created dashboards.

---
## ğŸ“ Folder Structure

For the scripts and pipeline to work correctly, your repository must adhere to the following structure:

```
dashboard-as-code/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ secops.yaml         # Your GitHub Actions workflow file
â”œâ”€â”€ dashboards/
â”‚   â”œâ”€â”€ dashboard_a.json        # Definition for Dashboard A
â”‚   â””â”€â”€ dashboard_b.json        # Definition for Dashboard B
â”œâ”€â”€ script/
â”‚   â”œâ”€â”€ main.py                 # Main Python script with Click commands
â”‚   â”œâ”€â”€ dashboard_manager.py    # Core logic for managing dashboards
â”‚   â””â”€â”€ ...                     # Other Python helper scripts
â”œâ”€â”€ requirements.txt            # Python dependencies
â””â”€â”€ README.md                   # This file
```

**Key components:**

*   **`dashboards/`**: Each `.json` file in this directory represents a single dashboard's configuration.
*   **`script/`**: Contains the Python scripts that handle the logic for planning, applying, and downloading dashboards.
*   **`output.yaml`**: A file generated by the scripts that consolidates the configuration of all dashboards.

---
## ğŸ› ï¸ Local Setup

1.  **Clone the repository:**
    ```bash
    git clone <your-repo-url>
    cd dashboard-as-code
    ```

2.  **Create and activate a Python virtual environment (recommended):**
    ```bash
    python3 -m venv venv
    source venv/bin/activate
    ```

3.  **Install dependencies:**
    ```bash
    pip install -r requirements.txt
    ```

4.  **Set Environment Variables (for local execution):**
    To run `script/main.py` locally, you will need to configure authentication to your SecOps platform.

---
## ğŸ’» Script Usage (CLI)

The `script/main.py` script uses [Click](https://click.palletsprojects.com/) for its command-line interface.

**Primary Commands:**

*   **Plan Changes:**
    This command validates local files and compares them with remote dashboards to generate an execution plan.
    ```bash
    python script/main.py plan
    ```

*   **Apply Changes:**
    This command applies the planned changes to the remote environment. It is intended to be run by the CI/CD pipeline after a PR is merged.
    ```bash
    python script/main.py apply
    ```

*   **Download Dashboards:**
    This command fetches remote dashboards and saves them locally.
    ```bash
    python script/main.py download --dashboard "My Dashboard Name"
    ```
---
## âš™ï¸ GitHub Actions Pipeline

The CI/CD pipeline automates the two-stage deployment process.

### Workflow Logic

**Stage 1: On Pull Request (Opened, Synchronized)**
1.  The `plan` job is triggered.
2.  It runs the `plan` command to validate the dashboard files and compare them to the remote state.
3.  It posts a **comment on the pull request** summarizing the planned changes (`create`, `update`, `delete`).
4.  Merging is only allowed if this job succeeds.

**Stage 2: On Pull Request (Closed & Merged)**
1.  The `apply` job is triggered.
2.  It runs the `apply` command to synchronize the changes with the remote environment.


### Environment Variables & Secrets

Configure the following in your GitHub repository settings (`Settings > Secrets and variables > Actions`):

**Workflow Environment Variables:**
These are non-sensitive and can be defined in the `env:` block of your workflow file.

```yaml
env:
  SECOPS_CUSTOMER_ID: "your-chronicle-customer-id"
  SECOPS_PROJECT_ID: "your-gcp-project-id"
  SECOPS_REGION: "your-chronicle-region"
  # For Workload Identity Federation (WIF)
  SERVICE_ACCOUNT: "your-gcp-service-account@your-project.iam.gserviceaccount.com"
  WIF_PROVIDER: "projects/your-gcp-project-number/locations/global/workloadIdentityPools/your-pool/providers/your-provider"
```

**IAM Permissions for Workload Identity Federation**

For more information on how to setup Workload Identity Federation with Google SecOps please refer to the following [article](https://medium.com/google-cloud/secure-google-secops-automations-the-definitive-guide-to-workload-identity-federation-5b1331db9c0c).

The GCP SERVICE_ACCOUNT used by the pipeline requires the following IAM permissions:

1- **Workload Identity User:**
Role: roles/iam.workloadIdentityUser
Principal: principalSet://iam.googleapis.com/projects/<PROJECT_NUMBER>/locations/global/workloadIdentityPools/<POOL_ID>/attribute.repository/<OWNER/REPO>

2- **Chronicle API Permissions:**
Role: roles/chronicle.admin (easiest) or a custom role with the following permissions:
- chronicle.nativeDashboards.create
- chronicle.nativeDashboards.delete
- chronicle.nativeDashboards.duplicate
- chronicle.nativeDashboards.get
- chronicle.nativeDashboards.list
- chronicle.nativeDashboards.update
- chronicle.dashboardCharts.get
- chronicle.dashboardCharts.list